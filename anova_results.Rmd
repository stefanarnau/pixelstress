---
title: "Mixed ANOVA Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)

# Load required packages
library(tidyverse)
library(ez)
library(emmeans)
library(ggplot2)
library(dplyr)
library(knitr)
library(patchwork)

# Set theme for plots
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r load-data}
# Set path
path_in <- "/mnt/data_dump/pixelstress/4_results"

# Read CSV file
df <- read.csv(file.path(path_in, "stats_table.csv"))

# Check if df exists and is a data frame
if (!exists("df") || !is.data.frame(df)) {
  stop("Please load your dataframe and name it 'df' before running this script.
       Example: df <- read.csv('your_data.csv')")
}

# Check if required columns exist
required_cols <- c("id", "group", "feedback", "stage", "rt", "accuracy", "cnv_Fz", "cnv_Cz")
missing_cols <- setdiff(required_cols, names(df))
if (length(missing_cols) > 0) {
  stop("Missing required columns: ", paste(missing_cols, collapse = ", "))
}

# Ensure factors are properly coded
df$id <- as.factor(df$id)
df$group <- as.factor(df$group)
df$feedback <- as.factor(df$feedback)
df$stage <- as.factor(df$stage)

# Display data structure
str(df)
head(df)

# Display factor levels
cat("Factor levels:\n")
cat("Group levels:", levels(df$group), "\n")
cat("Feedback levels:", levels(df$feedback), "\n")
cat("Stage levels:", levels(df$stage), "\n")
cat("Number of subjects:", length(unique(df$id)), "\n")
```

## Data Visualization

### Line Plots for Each Dependent Variable

```{r create-lineplots}
# List of dependent variables
dvs <- c("rt", "accuracy", "cnv_Fz", "cnv_Cz")

# Function to create line plots
create_lineplot <- function(dv) {
  # Calculate means and SDs
  plot_data <- df %>%
    group_by(group, stage, feedback) %>%
    summarise(
      mean_val = mean(!!sym(dv), na.rm = TRUE),
      sd_val = sd(!!sym(dv), na.rm = TRUE),
      n = n(),
      se_val = sd_val / sqrt(n),
      .groups = 'drop'
    )
  
  # Create the plot
  p <- ggplot(plot_data, aes(x = feedback, y = mean_val, color = group, linetype = stage)) +
    geom_line(aes(group = interaction(group, stage)), size = 1) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val), 
                  width = 0.1, size = 0.5) +
    labs(title = paste("Line Plot for", toupper(dv)),
         x = "Feedback",
         y = paste("Mean", dv, "± SD"),
         color = "Group",
         linetype = "Stage") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
          legend.position = "bottom")
  
  return(p)
}

# Create plots for all DVs
plots <- map(dvs, create_lineplot)
names(plots) <- dvs

# Display plots
walk2(plots, names(plots), ~{
  print(.x)
  cat("\n\n")
})
```

```{r combined-plot, fig.height=12, fig.width=15}
# Combine all plots
combined_plot <- wrap_plots(plots, ncol = 2)
print(combined_plot)
```

## Mixed ANOVA Analysis

```{r anova-functions}
# Function to run mixed ANOVA for each DV
run_mixed_anova <- function(dv) {
  cat(rep("=", 60), "\n")
  cat("MIXED ANOVA RESULTS FOR:", toupper(dv), "\n")
  cat(rep("=", 60), "\n")
  
  # Run mixed ANOVA using ezANOVA with proper variable passing
  anova_result <- do.call(ezANOVA, list(
    data = df,
    dv = as.name(dv),
    wid = as.name("id"),
    between = as.name("group"),
    within = list(as.name("stage"), as.name("feedback")),
    type = 3,
    detailed = TRUE,
    return_aov = TRUE
  ))
  
  # Print results
  print(anova_result$ANOVA)
  
  # Check for sphericity violations
  if (!is.null(anova_result$`Mauchly's Test for Sphericity`)) {
    cat("\nMauchly's Test for Sphericity:\n")
    print(anova_result$`Mauchly's Test for Sphericity`)
    
    if (!is.null(anova_result$`Sphericity Corrections`)) {
      cat("\nSphericity Corrections:\n")
      print(anova_result$`Sphericity Corrections`)
    }
  }
  
  return(anova_result)
}
```

```{r run-anovas}
# Run ANOVA for each DV
anova_results <- map(dvs, run_mixed_anova)
names(anova_results) <- dvs
```

## Post-hoc Tests for Feedback Factor

```{r posthoc-feedback}
# Function to run post-hoc tests for feedback if significant
run_feedback_posthoc <- function(dv, anova_result) {
  cat("\n" , rep("=", 50), "\n")
  cat("POST-HOC TESTS FOR FEEDBACK -", toupper(dv), "\n")
  cat(rep("=", 50), "\n")
  
  # Check if feedback main effect is significant (p < 0.05)
  feedback_p <- anova_result$ANOVA$p[anova_result$ANOVA$Effect == "feedback"]
  
  if (length(feedback_p) > 0 && feedback_p < 0.05) {
    cat("Feedback main effect is significant (p =", round(feedback_p, 4), ")\n")
    cat("Running pairwise comparisons...\n\n")
    
    # Create model for emmeans
    model <- aov(as.formula(paste(dv, "~ group * stage * feedback + Error(id/(stage*feedback))")), 
                 data = df)
    
    # Pairwise comparisons for feedback
    emm <- emmeans(model, ~ feedback)
    pairs <- pairs(emm, adjust = "bonferroni")
    
    print(emm)
    cat("\nPairwise comparisons:\n")
    print(pairs)
    
  } else {
    cat("Feedback main effect is not significant (p =", 
        ifelse(length(feedback_p) > 0, round(feedback_p, 4), "NA"), ")\n")
    cat("Skipping post-hoc tests.\n")
  }
}

# Run post-hoc tests for each DV
iwalk(anova_results, run_feedback_posthoc)
```

## Hierarchical Follow-up ANOVAs for Significant Interactions

```{r hierarchical-followup}
# Function to check for significant interactions and run follow-up tests
run_hierarchical_followup <- function(dv, anova_result) {
  cat("\n", rep("=", 60), "\n")
  cat("HIERARCHICAL FOLLOW-UP TESTS FOR:", toupper(dv), "\n")
  cat(rep("=", 60), "\n")
  
  anova_table <- anova_result$ANOVA
  
  # Check for 3-way interaction first
  three_way_p <- anova_table$p[anova_table$Effect == "group:stage:feedback"]
  
  if (length(three_way_p) > 0 && three_way_p < 0.05) {
    cat("3-way interaction is significant (p =", round(three_way_p, 4), ")\n")
    cat("Running follow-up ANOVAs for each GROUP level...\n\n")
    
    # Follow-up: separate 2-way ANOVAs for each group
    for (grp in levels(df$group)) {
      cat("--- GROUP:", grp, "---\n")
      subset_data <- df[df$group == grp, ]
      
      follow_up <- do.call(ezANOVA, list(
        data = subset_data,
        dv = as.name(dv),
        wid = as.name("id"),
        within = list(as.name("stage"), as.name("feedback")),
        type = 3,
        detailed = TRUE
      ))
      
      print(follow_up$ANOVA)
      
      # Check stage:feedback interaction within this group
      stage_feedback_p <- follow_up$ANOVA$p[follow_up$ANOVA$Effect == "stage:feedback"]
      
      if (length(stage_feedback_p) > 0 && stage_feedback_p < 0.05) {
        cat("Stage:Feedback interaction significant in", grp, "group (p =", round(stage_feedback_p, 4), ")\n")
        cat("Running follow-up ANOVAs for each STAGE level within", grp, "group...\n\n")
        
        # Further follow-up: separate 1-way ANOVAs for each stage within this group
        for (stg in levels(df$stage)) {
          cat("--- GROUP:", grp, ", STAGE:", stg, "---\n")
          subset_data2 <- subset_data[subset_data$stage == stg, ]
          
          follow_up2 <- do.call(ezANOVA, list(
            data = subset_data2,
            dv = as.name(dv),
            wid = as.name("id"),
            within = as.name("feedback"),
            type = 3,
            detailed = TRUE
          ))
          
          print(follow_up2$ANOVA)
          cat("\n")
        }
      }
      cat("\n")
    }
    
  } else {
    # Check 2-way interactions
    group_stage_p <- anova_table$p[anova_table$Effect == "group:stage"]
    group_feedback_p <- anova_table$p[anova_table$Effect == "group:feedback"]
    stage_feedback_p <- anova_table$p[anova_table$Effect == "stage:feedback"]
    
    if (length(group_stage_p) > 0 && group_stage_p < 0.05) {
      cat("Group:Stage interaction is significant (p =", round(group_stage_p, 4), ")\n")
      cat("Running simple effects of Stage for each Group...\n\n")
      
      for (grp in levels(df$group)) {
        cat("--- Simple effects of STAGE within GROUP:", grp, "---\n")
        subset_data <- df[df$group == grp, ]
        
        follow_up <- do.call(ezANOVA, list(
          data = subset_data,
          dv = as.name(dv),
          wid = as.name("id"),
          within = as.name("stage"),
          type = 3,
          detailed = TRUE
        ))
        
        print(follow_up$ANOVA)
        cat("\n")
      }
    }
    
    if (length(group_feedback_p) > 0 && group_feedback_p < 0.05) {
      cat("Group:Feedback interaction is significant (p =", round(group_feedback_p, 4), ")\n")
      cat("Running simple effects of Feedback for each Group...\n\n")
      
      for (grp in levels(df$group)) {
        cat("--- Simple effects of FEEDBACK within GROUP:", grp, "---\n")
        subset_data <- df[df$group == grp, ]
        
        follow_up <- do.call(ezANOVA, list(
          data = subset_data,
          dv = as.name(dv),
          wid = as.name("id"),
          within = as.name("feedback"),
          type = 3,
          detailed = TRUE
        ))
        
        print(follow_up$ANOVA)
        cat("\n")
      }
    }
    
    if (length(stage_feedback_p) > 0 && stage_feedback_p < 0.05) {
      cat("Stage:Feedback interaction is significant (p =", round(stage_feedback_p, 4), ")\n")
      cat("Running simple effects of Feedback for each Stage...\n\n")
      
      for (stg in levels(df$stage)) {
        cat("--- Simple effects of FEEDBACK within STAGE:", stg, "---\n")
        subset_data <- df[df$stage == stg, ]
        
        follow_up <- do.call(ezANOVA, list(
          data = subset_data,
          dv = as.name(dv),
          wid = as.name("id"),
          between = as.name("group"),
          within = as.name("feedback"),
          type = 3,
          detailed = TRUE
        ))
        
        print(follow_up$ANOVA)
        cat("\n")
      }
    }
    
    if ((length(group_stage_p) == 0 || group_stage_p >= 0.05) &&
        (length(group_feedback_p) == 0 || group_feedback_p >= 0.05) &&
        (length(stage_feedback_p) == 0 || stage_feedback_p >= 0.05) &&
        (length(three_way_p) == 0 || three_way_p >= 0.05)) {
      cat("No significant interactions found. No follow-up tests needed.\n")
    }
  }
}

# Run hierarchical follow-up tests for each DV
iwalk(anova_results, run_hierarchical_followup)
```

## Summary

```{r summary}
cat("Analysis completed for all dependent variables:\n")
cat("- Line plots created showing means ± SD for all factor combinations\n")
cat("- Mixed ANOVAs performed for each DV\n")
cat("- Post-hoc tests for feedback factor (when significant)\n")
cat("- Hierarchical follow-up ANOVAs for significant interactions\n")
cat("\nRefer to the sections above for detailed results.")
```

## Session Information

```{r session-info}
sessionInfo()
```